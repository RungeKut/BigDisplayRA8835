//-------------------------------------------------------------------------------------------------
//
//-------------------------------------------------------------------------------------------------
#include "sed1335.h"
#include "SED1335-STM32.h"
//-------------------------------------------------------------------------------------------------
// Funkcja inicjalizacji wyúwietlacza
//-------------------------------------------------------------------------------------------------
void GLCD_Initialize(void)
{
	GLCD_InitPorts();

	// === SYSTEM SET (0x40) ===
    GLCD_WriteCommand(0x40);
    GLCD_WriteData(0x36); // P1: 8bpp, 48 cols? –ù–µ—Ç ‚Äî —Å–º. –Ω–∏–∂–µ!
    // –ù–æ –¥–ª—è 320 —Ç–æ—á–µ–∫: 320 / 8 = 40 ‚Üí –±–ª–∏–∂–∞–π—à–µ–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 40 –∫–æ–ª–æ–Ω–æ–∫.
    // –û–¥–Ω–∞–∫–æ RA8835 –∫–æ–¥–∏—Ä—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –∫–∞–∫ (N-1), –∏ —à–∞–≥ ‚Äî 8 –∫–æ–ª–æ–Ω–æ–∫.
    // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏, –¥–æ—Å—Ç—É–ø–Ω—ã: 32, 40, 48, 56, 64 –∫–æ–ª–æ–Ω–æ–∫ ‚Üí 256, 320, 384, 448, 512 —Ç–æ—á–µ–∫.
    // –ó–Ω–∞—á–∏—Ç, 40 –∫–æ–ª–æ–Ω–æ–∫ = 320 —Ç–æ—á–µ–∫ ‚Üí –∫–æ–¥ = 0x34 + (40-32)/8 = 0x34 + 1 = 0x35?
    // –ù–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è RA8835: P1[2:0] = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫: 
    //   000=32, 001=40, 010=48, 011=56, 100=64
    // ‚Üí 40 –∫–æ–ª–æ–Ω–æ–∫ = 001 ‚Üí –±–∏—Ç—ã [2:0] = 001
    // –¢–∞–∫–∂–µ: P1[7:3] ‚Äî –ø—Ä–æ—á–∏–µ —Ñ–ª–∞–≥–∏

    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è 320x240:
    GLCD_WriteData(0x35); // P1: 8bpp, 40 cols (320 dots), internal clock, etc.
    GLCD_WriteData(0x87); // P2: CGROM selected, 240 lines per plane
    GLCD_WriteData(0x07); // P3: TCYC = 7 (~200ns cycle time)
    GLCD_WriteData(0x27); // P4: 40 chars/line = 40 bytes = 320 dots
    GLCD_WriteData(0x1F); // P5: 32 lines per screen? –ù–µ—Ç ‚Äî –¥–ª—è 240 –ª–∏–Ω–∏–π:
                              // –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ P5 = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–Ω–∏–π –Ω–∞ —ç–∫—Ä–∞–Ω - 1
                              // –ù–æ RA8835 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "—Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏", 1 —Å—Ç—Ä–æ–∫–∞ = 8 —Ç–æ—á–µ–∫
                              // ‚Üí 240 / 8 = 30 —Å—Ç—Ä–æ–∫ ‚Üí P5 = 29 = 0x1D
                              // –û–¥–Ω–∞–∫–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç 32 (0x1F) –∏ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–æ–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –¥–æ 240
    GLCD_WriteData(0x00); // P6: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    GLCD_WriteData(0x00); // P7: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

    // === SCROLL (0x44) ===
    GLCD_WriteCommand(0x44);
    GLCD_WriteData(0x00); // NL0-NL7
    GLCD_WriteData(0x00); // NL8-NL10 + AD0-AD2
    GLCD_WriteData(0x00); // AD3-AD10
    GLCD_WriteData(0xEF); // AD11-AD15: –Ω–∞—á–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –≤–∏–¥–µ–æ–ø–∞–º—è—Ç–∏ (–æ–±—ã—á–Ω–æ 0)
                              // –ù–æ –≤–∞–∂–Ω–æ: —Ä–∞–∑–º–µ—Ä –ø–ª–æ—Å–∫–æ—Å—Ç–∏ = 40 * 240 = 9600 –±–∞–π—Ç
                              // –î–ª—è 240 –ª–∏–Ω–∏–π ‚Üí 240 * 40 = 9600 ‚Üí 0x2580
                              // –û–¥–Ω–∞–∫–æ SCROLL.P3 –∑–∞–¥–∞—ë—Ç –≤—ã—Å–æ—Ç—É –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –≤ –ª–∏–Ω–∏—è—Ö
    GLCD_WriteData(0x00); // RAM size: –æ–±—ã—á–Ω–æ 0 = 32KB
    GLCD_WriteData(0x00); // reserved
    GLCD_WriteData(0x00); // reserved
    GLCD_WriteData(0x00); // reserved

    // –ù–æ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ: –∑–∞–¥–∞—Ç—å –≤—ã—Å–æ—Ç—É –ø–ª–æ—Å–∫–æ—Å—Ç–∏ = 240 –ª–∏–Ω–∏–π
    // ‚Üí P3 = 240 - 1 = 239 = 0xEF (–º–ª–∞–¥—à–∏–µ 8 –±–∏—Ç)
    // ‚Üí P2[7:5] = —Å—Ç–∞—Ä—à–∏–µ 3 –±–∏—Ç–∞ (239 = 0x00EF ‚Üí —Å—Ç–∞—Ä—à–∏–µ = 0)
    // ‚Üí –ø–æ—ç—Ç–æ–º—É P2 = 0x00, P3 = 0xEF ‚Äî –≤–µ—Ä–Ω–æ

    // === HDOT SCR (0x5A) ===
    GLCD_WriteCommand(0x5A);
    GLCD_WriteData(0x00); // –±–µ–∑ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∂–∞—Ç–∏—è/—Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è

    // === OVLAY (0x58) ===
    GLCD_WriteCommand(0x58);
    GLCD_WriteData(0x00); // —Ç–æ–ª—å–∫–æ –≥—Ä–∞—Ñ–∏–∫–∞ (–±–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–ª–æ—è)

    // === CSRW (0x46) ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å –∑–∞–ø–∏—Å–∏ ===
    GLCD_WriteCommand(0x46);
    GLCD_WriteData(0x00); // –º–ª–∞–¥—à–∏–π –±–∞–π—Ç –∞–¥—Ä–µ—Å–∞
    GLCD_WriteData(0x00); // —Å—Ç–∞—Ä—à–∏–π –±–∞–π—Ç –∞–¥—Ä–µ—Å–∞

    // === OTS (0x4C) ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç ===
    GLCD_WriteCommand(0x4C);
}
//-------------------------------------------------------------------------------------------------
// Funkcja zapalajπca piksel
//-------------------------------------------------------------------------------------------------
void GLCD_SetPixel(unsigned int x,unsigned int y, int color)
{
unsigned char tmp = 0;
unsigned int address = SED1335_GRAPHICSTART + (40 * y) + (x/8); 
GLCD_SetCursorAddress(address);

GLCD_WriteCommand(SED1335_MREAD);
tmp = GLCD_ReadData();

if(color)
  tmp |= (1 << (SED1335_FX - (x % 8)));
else
  tmp &= ~(1 << (SED1335_FX - (x % 8)));

GLCD_SetCursorAddress(address);
GLCD_WriteCommand(SED1335_MWRITE);
GLCD_WriteData(tmp);
}
//-------------------------------------------------------------------------------------------------
// Funkcja wyswietlajaca tekst
//-------------------------------------------------------------------------------------------------
void GLCD_WriteText(char * tekst)
{
GLCD_WriteCommand(SED1335_MWRITE);
while(*tekst)
	GLCD_WriteData(*tekst++);
}
//-------------------------------------------------------------------------------------------------
// Funkcja wyúwietlajπca tekst z pamiÍci programu (AVR)
//-------------------------------------------------------------------------------------------------
void GLCD_WriteTextP(char * tekst)
{
GLCD_WriteCommand(SED1335_MWRITE);
while(GLCD_ReadByteFromROMMemory(tekst))
	GLCD_WriteData(GLCD_ReadByteFromROMMemory(tekst++));
}
//-------------------------------------------------------------------------------------------------
// Funkcja ustawiajπca adres kursora
//-------------------------------------------------------------------------------------------------
void GLCD_SetCursorAddress(unsigned int address)
{
GLCD_WriteCommand(SED1335_CSRW);
GLCD_WriteData((unsigned char)(address & 0xFF));
GLCD_WriteData((unsigned char)(address >> 8));
}
//-------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------
void GLCD_TextGoTo(unsigned char x, unsigned char y)
{
GLCD_SetCursorAddress((y * 40) + x);
}
//-------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------
void GLCD_GraphicGoTo(unsigned int x, unsigned int y)
{
GLCD_SetCursorAddress(SED1335_GRAPHICSTART + (y * 40) + x/8);
}
//-------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------
void GLCD_ClearText(void)
{
int i;
GLCD_TextGoTo(0,0);
GLCD_WriteCommand(SED1335_MWRITE);
for(i = 0; i < 1200; i++)
	GLCD_WriteData(' ');
}
//-------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------
void GLCD_ClearGraphic(void)
{
unsigned int i;
GLCD_SetCursorAddress(SED1335_GRAPHICSTART);
GLCD_WriteCommand(SED1335_MWRITE);
for(i = 0; i < (40 * 240); i++)
	GLCD_WriteData(0x00);
}
//-------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------
void GLCD_Bitmap(char * bmp, int x, int y, int width, int height)
{
unsigned int i, j;
for(i = 0; i < height ; i++)
	{
	GLCD_GraphicGoTo(x, y+i);
	GLCD_WriteCommand(SED1335_MWRITE);
	for(j = 0; j < width/8; j++)
		GLCD_WriteData(GLCD_ReadByteFromROMMemory(bmp+j+(40*i)));
	}
}
//-------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------

